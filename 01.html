<!DOCTYPE html>
<html lang="ko">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>짐보내기게임</title>


    <style>
        body {
            background-image: url('back01.png');
            overflow: hidden;

            background-repeat: no-repeat;

            background-size: 55vh;
            left: 40%;
            font-family: "Gugi", sans-serif;

            font-style: normal;
            font-size: 15px;



        }


        .mystuff {
            width: 100px;
            height: 100px;
            position: absolute;
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;


        }






        #myVideo {

            display: block;

            width: 70%;
            height: auto;


            border-style: solid;
            border-width: 10px;
            border-radius: 10px;
            border-color: rgb(104, 112, 223);
            position: relative;
            left: 10%;

            z-index: 1000;
        }



        #win {

            background-color: rgb(236, 247, 255);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            color: rgb(33, 12, 124);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 250px;
            opacity: 1;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 22px;
            z-index: 9999;
            display: none;

        }


        #lose {
            background-color: rgb(236, 247, 255);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            color: rgb(33, 12, 124);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 250px;
            opacity: 1;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            font-size: 22px;
            display: none;
            z-index: 9999;

        }


        #target {
            width: 200px;
            height: 200px;
            background-color: #dc858550;
            position: absolute;
            opacity: 0;
            top: 70px;
            left: 100px;
            z-index: -1;
        }




        #successful-stuff-images img {
            width: 20%;
            /* 이미지 너비 */
            height: 20%;
            object-fit: cover;




        }






        /*설명창*/
        .explanation-content {

            background-color: rgb(236, 247, 255);
            position: absolute;
            padding: 10px;
            left: 50%;
            transform: translateX(-50%);
            top: 14%;
            border-radius: 8px;
            text-align: center;
            color: rgb(33, 12, 124);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 300px;
            opacity: 0.9;


            justify-content: center;
            align-items: center;


            z-index: 99999;
        }

        /*설명창닫기버튼*/
        .close-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: rgb(33, 12, 124);
            color: rgb(255, 255, 255);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            z-index: 9999;

        }











        /*배경*/

        #leftbeam01,
        #rightbeam01 {
            height: 100%;
            left: 0%;
            top: 0%;
            position: absolute;
            z-index: -9999;

            mix-blend-mode: soft-light;
            opacity: 1;
            animation: blinkRain 1s infinite alternate;
        }

        @keyframes blinkRain {
            0% {
                opacity: 0;

            }

            100% {
                opacity: 0.7;

            }
        }





        #alien01 {
            width: 100%;
            left: 0%;
            top: 0%;
            position: absolute;
            z-index: -9998;

        }

        #earth01 {
            width: 115%;
            left: 0%;
            top: 2%;
            position: absolute;
            z-index: -9998;
        }


        #woolsey01 {
            width: 110%;
            top: 4%;
            left: 1%;
            position: absolute;
            z-index: -9998;
        }
    </style>
</head>


<body>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gugi&display=swap');
    </style>

    </video>



    <img id="alien01" src="alien01.png">
    <img id="earth01" src="earth01.png">
    <img id="leftbeam01" src="leftbeam01.png">
    <img id="rightbeam01" src="rightbeam01.png">
    <img id="woolsey01" src="woolsey01.png">



    <div id="win"></div>
    <div id="lose"></div>





    <div id="phone" class="mystuff" data-image="phone.png" data-start-left="60vw" data-start-top="60vh"
        data-attempts="0"></div>
    <div id="seed" class="mystuff" data-image="seed.png" data-start-left="50vw" data-start-top="70vh" data-attempts="0">
    </div>
    <div id="rainbow" class="mystuff" data-image="rainbow.png" data-start-left="30vw" data-start-top="65vh"
        data-attempts="0"></div>
    <div id="mirror" class="mystuff" data-image="mirror.png" data-start-left="70vw" data-start-top="75vh"
        data-attempts="0"></div>
    <div id="door" class="mystuff" data-image="door.png" data-start-left="2vw" data-start-top="70vh" data-attempts="0">
    </div>
    <div id="matcha" class="mystuff" data-image="matcha.png" data-start-left="24vw" data-start-top="78vh"
        data-attempts="0"></div>



    <div id="target"></div>

    <div id="explanationModal" class="explanation-content">
        <h2>짐을 던져보자</h2>
        <p> 짐을 당겼다 날려 외계 행성으로 보내주세요</p>
        <p> 외계인 시야에 들지 않게 보내야 해요!</p>

        <video id="myVideo" autoplay muted loop>
            <source src="playvideo.mp4" type="video/mp4">
        </video>

        <button class="close-button" onclick="closeExplanation()">닫기</button>
    </div>




    <script>
        const mystuffs = document.querySelectorAll('.mystuff');
        const wincaption = document.getElementById('win')
        const losecaption = document.getElementById('lose')
        const target = document.getElementById('target');


        let currentStuff = null;


        let isDragging = false;
        let startX, startY;
        let gamedone = false; // 게임 전체 종료


        let sentStuffs = []; //보내기성공짐이름리스트


        const FORCE_MULTIPLIER = 14;


        // 공이 착지할 최소 최대 거리
        const MIN_TRAVEL = 400;
        const MAX_TRAVEL = 600;


        const INITIAL_LEFT = '40vw';
        const INITIAL_TOP = '60vh';


        const TARGET_AREA = {
            top: 70,
            bottom: 70 + 200,
            left: 100,
            right: 100 + 200
        };


        // 짐 초기 좌표로 초기화하는 함수
        function initializeStuff(stuff) {
            const initialLeft = stuff.getAttribute('data-start-left') || INITIAL_LEFT;
            const initialTop = stuff.getAttribute('data-start-top') || INITIAL_TOP;
            const imagePath = stuff.getAttribute('data-image');

            stuff.style.left = initialLeft;
            stuff.style.top = initialTop;
            stuff.style.backgroundImage = `url('${imagePath}')`;
            stuff.style.pointerEvents = 'auto'; // 모든 짐 활성화
            stuff.style.transition = 'none';
        }


        mystuffs.forEach(initializeStuff);


        // resetball 함수 (stuff 인수를 받음)
        function resetball(stuff, isFinalFix = false, finalX, finalY) {
            const initialLeft = stuff.getAttribute('data-start-left') || INITIAL_LEFT;
            const initialTop = stuff.getAttribute('data-start-top') || INITIAL_TOP;

            stuff.style.transition = 'none';
            wincaption.style.display = 'none';
            losecaption.style.display = 'none';
            if (!isFinalFix) {
                stuff.style.transform = 'translate(0, 0)';
                stuff.style.left = initialLeft; // stuff의 개별시작점 사용
                stuff.style.top = initialTop;
            } else {
                stuff.style.transform = 'translate(0, 0)';
                stuff.style.left = (finalX - stuff.offsetWidth / 2) + 'px';
                stuff.style.top = (finalY - stuff.offsetHeight / 2) + 'px';
            }
        }


        // winorlose 함수 (stuff 인수를 받음)
        function winorlose(stuff, finalX, finalY) {
            //타겟 좌표 안에 짐의 중앙에 왔니?
            const isInsideTarget = (
                finalX >= TARGET_AREA.left &&
                finalX <= TARGET_AREA.right &&
                finalY >= TARGET_AREA.top &&
                finalY <= TARGET_AREA.bottom
            );


            if (isInsideTarget) {
                // ⭐️ 성공 처리 로직
                resetball(stuff, true, finalX, finalY);
                wincaption.textContent = `${stuff.id} 보내기 성공!`;
                wincaption.style.display = 'block';
                stuff.style.pointerEvents = 'none'; // 성공한 짐 비활성화

                if (!sentStuffs.includes(stuff.id)) {
                    sentStuffs.push(stuff.id); // ⭐️ 성공 리스트에 추가
                }
                checkGameEnd(); // 성공 후 바로 게임 종료 확인
                return true;

            }
            else {
                // 실패 처리 로직 (총 3회 제한)
                let currentAttempts = parseInt(stuff.getAttribute('data-attempts')) + 1;
                stuff.setAttribute('data-attempts', currentAttempts); // 시도 횟수 갱신


                if (currentAttempts <= 2) {
                    losecaption.textContent = `${stuff.id} 보내기 실패! 다시 시도해보세요! ${currentAttempts} / 2회`;
                    losecaption.style.display = 'block';

                    setTimeout(() => {
                        resetball(stuff, false);
                        checkGameEnd(); // 재시도 후 게임 종료 확인
                    }, 1000);
                } else {
                    resetball(stuff, true, finalX, finalY);
                    losecaption.textContent = `${stuff.id} 보내기 실패! 이 짐은 행성에 가져갈 수 없어요`;
                    losecaption.style.display = 'block';


                    stuff.style.pointerEvents = 'none';
                    checkGameEnd();
                }
                return false;
            }
        }



        mystuffs.forEach(stuff => {
            stuff.addEventListener('touchstart', (e) => {
                // 실패 횟수 초과 시나, 이미 보낸 짐은 드래그 불가
                if (gamedone || stuff.style.pointerEvents === 'none') return;
                currentStuff = stuff;
                isDragging = true;
                startX = currentStuff.offsetLeft + currentStuff.offsetWidth / 2;
                startY = currentStuff.offsetTop + currentStuff.offsetHeight / 2;


                e.preventDefault();
                currentStuff.style.transition = 'none';
            }, { passive: false });
        });



        document.addEventListener('touchmove', (e) => {
            if (!isDragging || gamedone || !currentStuff) return;
            const touch = e.touches[0];
            currentStuff.style.left = (touch.clientX - currentStuff.offsetWidth / 2) + 'px';
            currentStuff.style.top = (touch.clientY - currentStuff.offsetHeight / 2) + 'px';
            e.preventDefault();
        }, { passive: false });


        // touchend 이벤트 처리
        document.addEventListener('touchend', (e) => {
            if (!isDragging || gamedone || !currentStuff) return;
            isDragging = false; //드래그끝


            const stuffToThrow = currentStuff;
            currentStuff = null;

            const touch = e.changedTouches[0];
            let endX = touch.clientX;
            let endY = touch.clientY;


            //던질 방향을 계산! = vector
            let directionX = (startX - endX) * FORCE_MULTIPLIER;
            let directionY = (startY - endY) * FORCE_MULTIPLIER;


            // Magnitude=힘의 크기 계산
            let originalMagnitude = Math.sqrt(
                (directionX * directionX) + (directionY * directionY)
            );



            const randomTravelRange = MAX_TRAVEL - MIN_TRAVEL;
            const randomMagnitude = Math.random() * randomTravelRange + MIN_TRAVEL;


            //공이 날아갈 최종 벡터 계산을 위해 초기화
            let movingX = 0;
            let movingY = 0;
            let finalX = stuffToThrow.offsetLeft + stuffToThrow.offsetWidth / 2;
            let finalY = stuffToThrow.offsetTop + movingY + (stuffToThrow.offsetHeight / 2);

            // 당긴 힘이 0이 아닐 때만 적용
            if (originalMagnitude > 0) {



                const scaleFactor = randomMagnitude / originalMagnitude;
                movingX = directionX * scaleFactor;
                movingY = directionY * scaleFactor;


                //최종도착좌표
                finalX = stuffToThrow.offsetLeft + movingX + (stuffToThrow.offsetWidth / 2);
                finalY = stuffToThrow.offsetTop + movingY + (stuffToThrow.offsetHeight / 2);


                stuffToThrow.style.transition = 'transform 1s ease-out';
                stuffToThrow.style.transform = `translate(${movingX}px, ${movingY}px)`;
            }


            setTimeout(() => {
                winorlose(stuffToThrow, finalX, finalY); // stuffToThrow 전달
            }, 1000);
        });




        //설명창

        function closeExplanation() {

            const explanation = document.getElementById('explanationModal');

            explanation.style.display = 'none';
        }


        // #### 기회 소진 후 성공 짐 리스트 출력//
        function showFinalResults() {
            wincaption.style.display = 'block';
            losecaption.style.display = 'none';

            localStorage.setItem('SuccessfulStuffs', JSON.stringify(sentStuffs));

            let imagesHtml = '';
            if (sentStuffs.length > 0) {
                // sentStuffs 배열의 각 짐 ID에 해당하는 이미지 경로를 찾아서 img 태그 생성
                imagesHtml = sentStuffs.map(stuffId => {
                    const stuffElement = document.getElementById(stuffId);
                    if (stuffElement) {

                        const imagePath = stuffElement.getAttribute('data-image');
                        return `<img src="${imagePath}" alt="${stuffId}" title="${stuffId}">`;
                    }
                    return '';
                }).join(''); // 모든 img 태그들을 하나의 문자열로 합침

                imagesHtml = `<div id="successful-stuff-images">${imagesHtml}</div>`;
            } else {
                imagesHtml = '<p>아쉽지만 보낸 짐이 없습니다.</p>';
            }

            // 결과 팝업(#win)에 HTML 내용을 삽입
            wincaption.innerHTML = `
                <h2>짐을 다 보냈어요!</h2>
                <p>울지 행성에 도착한 짐:</p>
                ${imagesHtml} 
                <a href="02.html"
                   style="
                       display: inline-block;
                       padding: 10px 20px;
                       font-size: 18px;
                       font-weight: bold;
                       cursor: pointer;
                       background-color:  rgb(33, 12, 124);
                       color: white;
                       border: none;
                       border-radius: 5px;
                       margin-top: 15px;
                       text-decoration: none;
                       font-family: 'Gugi', sans-serif;
                   "
                >이제 떠나자</a>
            `;
        }




        function checkGameEnd() {

            const allAttemptsDone = Array.from(mystuffs).every(stuff => {
                const attempts = parseInt(stuff.getAttribute('data-attempts'));


                return attempts >= 3 || stuff.style.pointerEvents === 'none';
            });

            if (allAttemptsDone && !gamedone) {
                gamedone = true;
                showFinalResults();
            }
        }
    </script>
</body>

</html>